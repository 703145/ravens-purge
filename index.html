<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forbidden Lands RPG Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .brush-size {
            width: 100px;
            margin: 5px 0;
        }
        .button {
            margin: 5px;
            padding: 5px 10px;
            cursor: pointer;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .button:hover {
            background: #e0e0e0;
        }
        .button.active {
            background: #007bff;
            color: white;
        }
        #cursor {
            position: absolute;
            border: 2px solid red;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div>
            <button id="gm-toggle" class="button">GM Mode: OFF</button>
        </div>
        <div>
            <button id="reveal-toggle" class="button">Reveal Mode</button>
            <button id="erase-toggle" class="button">Erase Mode</button>
        </div>
        <div>
            <label>Brush Size: <span id="brush-size-display">20</span></label>
            <input type="range" id="brush-size" class="brush-size" min="10" max="100" value="20">
        </div>
        <div>
            <button id="save-map" class="button">Save Map</button>
            <button id="clear-map" class="button">Clear All</button>
        </div>
    </div>

    <div id="cursor"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const mapWidth = 8563;
        const mapHeight = 6201;
        const mapBounds = [[0, 0], [mapHeight, mapWidth]];

        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 2,
            zoomControl: true,
            maxBounds: mapBounds,
            maxBoundsViscosity: 1.0
        });

        // Load map image
        const mapImage = L.imageOverlay('assets/ravenland-map.jpg', mapBounds).addTo(map);
        map.fitBounds(mapBounds);
        map.setView([mapHeight / 2, mapWidth / 2], 0);

        // Create canvas overlay for revealed areas
        const canvas = document.createElement('canvas');
        canvas.width = mapWidth;
        canvas.height = mapHeight;
        const ctx = canvas.getContext('2d');

        // Initialize with black (fog)
        function initializeFog() {
            ctx.fillStyle = 'black';
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillRect(0, 0, mapWidth, mapHeight);
            updateCanvasLayer();
        }

        const canvasLayer = L.imageOverlay(canvas, mapBounds).addTo(map);
        initializeFog();

        // UI elements
        const gmToggle = document.getElementById('gm-toggle');
        const revealToggle = document.getElementById('reveal-toggle');
        const eraseToggle = document.getElementById('erase-toggle');
        const brushSize = document.getElementById('brush-size');
        const brushSizeDisplay = document.getElementById('brush-size-display');
        const cursor = document.getElementById('cursor');
        const saveMapBtn = document.getElementById('save-map');
        const clearMapBtn = document.getElementById('clear-map');

        // State
        let isGMMode = false;
        let isDrawing = false;
        let currentTool = 'reveal';
        
        // Load saved map state
        const savedMap = localStorage.getItem('rpgMapState');
        if (savedMap) {
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                updateCanvasLayer();
            };
            img.src = savedMap;
        }

        // Convert screen pixels to map units based on zoom
        function getScaledBrushSize() {
            const zoom = map.getZoom();
            const baseSize = parseInt(brushSize.value);
            const scale = Math.pow(2, zoom);
            return baseSize * scale;
        }

        function updateBrushSize() {
            const size = getScaledBrushSize();
            brushSizeDisplay.textContent = brushSize.value;
            cursor.style.width = size + 'px';
            cursor.style.height = size + 'px';
        }

        function updateCursor(e) {
            const size = getScaledBrushSize();
            cursor.style.left = (e.clientX - size/2) + 'px';
            cursor.style.top = (e.clientY - size/2) + 'px';
        }

        function draw(e) {
            if (!isGMMode) return;

            const point = map.mouseEventToLatLng(e);
            const containerPoint = map.latLngToContainerPoint(point);
            const bounds = map.getBounds();
            const topLeft = map.latLngToContainerPoint(bounds.getNorthWest());
            
            // Convert to canvas coordinates
            const x = (point.lng / mapWidth) * canvas.width;
            const y = canvas.height - (point.lat / mapHeight) * canvas.height; // Flip Y coordinate
            
            // Scale brush size based on zoom
            const scaledBrushSize = (getScaledBrushSize() / map.getContainer().clientWidth) * canvas.width;
            
            ctx.beginPath();
            ctx.arc(x, y, scaledBrushSize/2, 0, Math.PI * 2);
            
            if (currentTool === 'reveal') {
                ctx.globalCompositeOperation = 'destination-out';
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.fillStyle = 'black';
            }
            
            ctx.fill();
            updateCanvasLayer();
        }

        function updateCanvasLayer() {
            canvasLayer.setUrl(canvas.toDataURL());
        }

        // Event listeners
        map.on('mousemove', (e) => {
            if (isGMMode) {
                updateCursor(e.originalEvent);
                if (isDrawing) {
                    draw(e.originalEvent);
                }
            }
        });

        map.on('mousedown', (e) => {
            isDrawing = true;
            draw(e.originalEvent);
        });
        
        map.on('mouseup', () => isDrawing = false);
        
        map.on('mouseout', () => {
            isDrawing = false;
            cursor.style.display = 'none';
        });
        
        map.on('mouseover', () => {
            if (isGMMode) cursor.style.display = 'block';
        });

        map.on('zoom', updateBrushSize);

        gmToggle.addEventListener('click', () => {
            isGMMode = !isGMMode;
            gmToggle.textContent = 'GM Mode: ' + (isGMMode ? 'ON' : 'OFF');
            gmToggle.classList.toggle('active');
            cursor.style.display = isGMMode ? 'block' : 'none';
        });

        revealToggle.addEventListener('click', () => {
            currentTool = 'reveal';
            revealToggle.classList.add('active');
            eraseToggle.classList.remove('active');
        });

        eraseToggle.addEventListener('click', () => {
            currentTool = 'erase';
            eraseToggle.classList.add('active');
            revealToggle.classList.remove('active');
        });

        brushSize.addEventListener('input', updateBrushSize);

        saveMapBtn.addEventListener('click', () => {
            localStorage.setItem('rpgMapState', canvas.toDataURL());
            alert('Map state saved!');
        });

        clearMapBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all revealed areas?')) {
                initializeFog();
                localStorage.removeItem('rpgMapState');
            }
        });

        // Initial setup
        updateBrushSize();
        revealToggle.classList.add('active');
    </script>
</body>
</html>